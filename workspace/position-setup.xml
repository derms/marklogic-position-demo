<export><workspace name="position-setup"><query name="1.a bitemporal setup" focus="false" active="true" content-source="as:5497110870981293542:" mode="javascript">declareUpdate({explicitCommit: true});
var temporal = require("/MarkLogic/temporal.xqy");
var validResult = temporal.axisCreate(
    "valid",
    cts.elementReference(fn.QName("", "validStart")),
    cts.elementReference(fn.QName("", "validEnd")));
var systemResult = temporal.axisCreate(
    "system",
    cts.elementReference(fn.QName("", "systemStart")),
    cts.elementReference(fn.QName("", "systemEnd")));

var collectionResult = temporal.collectionCreate(
"position", "system", "valid");
xdmp.commit();</query><query name="1.b bitemporal setup" focus="false" active="true" content-source="as:8835728600297522868:" mode="javascript">declareUpdate({explicitCommit: true});
var temporal = require("/MarkLogic/temporal.xqy");
temporal.setUseLsqt("position", true);
xdmp.commit();</query><query name="2. load bitemporal documents" focus="true" active="true" content-source="as:2705163930569127974:" mode="javascript">declareUpdate();

//load the position temporal data in different transaction
function insertPositionData(filename, node, systemStartTime) {
  xdmp.eval('declareUpdate();  \n\
            temporal.documentInsert("position", "/domain/position/' + filename +'",' + node +', null, ["/type/position"]) \n\
            temporal.statementSetSystemTime(xs.dateTime("' + systemStartTime +'")); ',
            null,
            {
            "isolation" : "different-transaction"
            } );
}

function sortByFilenames(a,b) {
   var keyA = a.filename,
       keyB = b.filename;
  // Compare the 2 filenames
  if(keyA &lt; keyB) return -1;
  if(keyA &gt; keyB) return 1;
  return 0;
}

function loadDirectoryContents(path) {
  var directoryContents = xdmp.filesystemDirectory(path);
  directoryContents = directoryContents.sort(sortByFilenames);
  for(var i in directoryContents) {
    var dir = directoryContents[i];
    node = dir;
    if (dir.type="dir") {
        var dataFiles = xdmp.filesystemDirectory(dir.pathname);
        dataFiles = dataFiles.sort(sortByFilenames);
        for(var j in dataFiles) {
            var file = dataFiles[j];
          output = file;
          if (file.type="file") {
             node = xdmp.toJSON(xdmp.fromJsonString(xdmp.filesystemFile(file.pathname)));
             systemStartTime = node.root.systemStart;
             insertPositionData(dir.filename, node, systemStartTime);
          }

        }
    }
  }
}
loadDirectoryContents('/home/ec2-user/marklogic-position-demo/data/position');</query><query name="3. delete bitemporal documents (useful)" focus="false" active="true" content-source="as:2705163930569127974:" mode="javascript">declareUpdate();
var temporal = require("/MarkLogic/temporal.xqy");
temporal.collectionSetOptions("position", ["updates-admin-override"]) ;
xdmp.directoryDelete("/");

</query></workspace></export>
